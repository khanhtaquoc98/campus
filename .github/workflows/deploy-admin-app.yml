name: Deploy Admin App to AWS VPS

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'admin-app/**'
  workflow_dispatch:

env:
  APP_NAME: admin-app
  DOCKER_IMAGE: admin-app
  CONTAINER_NAME: admin-app

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            admin-app/package-lock.json
            admin-app/yarn.lock

      - name: Install dependencies
        working-directory: ./admin-app
        run: |
          if [ -f yarn.lock ]; then yarn install --frozen-lockfile; else npm ci; fi

      - name: Run lint
        working-directory: ./admin-app
        run: npm run lint

      # - name: Set up Docker Buildx
      #   uses: docker/setup-buildx-action@v3

      # - name: Build Docker image
      #   working-directory: ./admin-app
      #   run: |
      #     docker build -t ${{ env.DOCKER_IMAGE }}:${{ github.sha }} .
      #     docker tag ${{ env.DOCKER_IMAGE }}:${{ github.sha }} ${{ env.DOCKER_IMAGE }}:latest

      # - name: Save Docker image
      #   run: |
      #     docker save ${{ env.DOCKER_IMAGE }}:latest | gzip > ${{ env.DOCKER_IMAGE }}.tar.gz

      # - name: Deploy to AWS VPS
      #   uses: appleboy/scp-action@v0.1.7
      #   with:
      #     host: ${{ secrets.AWS_VPS_HOST }}
      #     username: ${{ secrets.AWS_VPS_USER }}
      #     key: ${{ secrets.AWS_VPS_SSH_KEY }}
      #     port: ${{ secrets.AWS_VPS_PORT || 22 }}
      #     source: "${{ env.DOCKER_IMAGE }}.tar.gz"
      #     target: "/tmp/"

      # - name: Load and deploy Docker image on VPS
      #   uses: appleboy/ssh-action@v1.0.3
      #   with:
      #     host: ${{ secrets.AWS_VPS_HOST }}
      #     username: ${{ secrets.AWS_VPS_USER }}
      #     key: ${{ secrets.AWS_VPS_SSH_KEY }}
      #     port: ${{ secrets.AWS_VPS_PORT || 22 }}
      #     script: |
      #       # Create Docker network if not exists
      #       docker network create app-network || true
            
      #       # Load Docker image
      #       docker load < /tmp/${{ env.DOCKER_IMAGE }}.tar.gz
            
      #       # Stop and remove existing container if exists
      #       docker stop ${{ env.CONTAINER_NAME }} || true
      #       docker rm ${{ env.CONTAINER_NAME }} || true
            
      #       # Run new container
      #       docker run -d \
      #         --name ${{ env.CONTAINER_NAME }} \
      #         --restart unless-stopped \
      #         -p 4001:80 \
      #         --network app-network \
      #         ${{ env.DOCKER_IMAGE }}:latest
            
      #       # Clean up old images
      #       docker image prune -f
            
      #       # Clean up temp file
      #       rm -f /tmp/${{ env.DOCKER_IMAGE }}.tar.gz

      # - name: Clean up local files
      #   if: always()
      #   run: |
      #     rm -f ${{ env.DOCKER_IMAGE }}.tar.gz

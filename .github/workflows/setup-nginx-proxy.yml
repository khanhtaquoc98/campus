# name: Setup Nginx Reverse Proxy

# on:
#   workflow_dispatch:
#   push:
#     branches:
#       - main
#     paths:
#       - 'nginx-reverse-proxy.conf'
#       - 'docker-compose.yml'

# env:
#   NGINX_CONTAINER: nginx-proxy

# jobs:
#   setup-nginx:
#     runs-on: ubuntu-latest
    
#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4

#       - name: Deploy nginx config to AWS VPS
#         uses: appleboy/scp-action@v0.1.7
#         with:
#           host: ${{ secrets.AWS_VPS_HOST }}
#           username: ${{ secrets.AWS_VPS_USER }}
#           key: ${{ secrets.AWS_VPS_SSH_KEY }}
#           port: ${{ secrets.AWS_VPS_PORT || 22 }}
#           source: "nginx-reverse-proxy.conf,docker-compose.yml"
#           target: "/home/${{ secrets.AWS_VPS_USER }}/"

#       - name: Setup and start nginx proxy
#         uses: appleboy/ssh-action@v1.0.3
#         with:
#           host: ${{ secrets.AWS_VPS_HOST }}
#           username: ${{ secrets.AWS_VPS_USER }}
#           key: ${{ secrets.AWS_VPS_SSH_KEY }}
#           port: ${{ secrets.AWS_VPS_PORT || 22 }}
#           script: |
#             # Create app-network if not exists
#             docker network create app-network || true
            
#             # Stop existing nginx proxy if exists
#             docker stop ${{ env.NGINX_CONTAINER }} || true
#             docker rm ${{ env.NGINX_CONTAINER }} || true
            
#             # Start nginx proxy
#             docker run -d \
#               --name ${{ env.NGINX_CONTAINER }} \
#               --restart unless-stopped \
#               -p 80:80 \
#               --network app-network \
#               -v /home/${{ secrets.AWS_VPS_USER }}/nginx-reverse-proxy.conf:/etc/nginx/conf.d/default.conf:ro \
#               nginx:alpine
            
#             # Reload nginx config
#             docker exec ${{ env.NGINX_CONTAINER }} nginx -s reload || true

